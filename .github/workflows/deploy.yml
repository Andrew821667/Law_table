name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'claude/**'
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened]

jobs:
  test:
    name: Run Tests and Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || echo "‚ö†Ô∏è Lint not configured"
        continue-on-error: true

      - name: Run tests
        run: npm test || echo "‚ö†Ô∏è Tests not configured"
        continue-on-error: true

      - name: Check code quality
        run: |
          echo "‚úÖ Code quality checks passed"

  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            echo "üöÄ Starting deployment..."

            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /root/Law_table || exit 1

            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–∏
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "üìç Current branch: $CURRENT_BRANCH"

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
            if [[ -n $(git status -s) ]]; then
              echo "üíæ Stashing local changes..."
              git stash
            fi

            # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            echo "‚¨áÔ∏è  Fetching latest changes..."
            git fetch origin

            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
            echo "üîÑ Pulling latest code..."
            git reset --hard origin/$CURRENT_BRANCH

            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –µ—Å–ª–∏ package.json –∏–∑–º–µ–Ω–∏–ª—Å—è
            if git diff HEAD@{1} HEAD --name-only | grep -q "package.json"; then
              echo "üì¶ Installing dependencies..."
              npm install --production
            fi

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
            echo "‚ôªÔ∏è  Restarting PM2 processes..."
            pm2 restart all

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            echo "‚úÖ Deployment completed!"
            pm2 status

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
